// cmd/server/main.go - –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Ä–≤–µ—Ä–∞ VisualMath —Å OAuth
package main

import (
    "database/sql"
    "fmt"
    "log"
    "net/http"
    "os"
    
    "github.com/go-chi/chi/v5"
    "github.com/go-chi/chi/v5/middleware"
    "github.com/joho/godotenv"
    _ "github.com/lib/pq" // –î—Ä–∞–π–≤–µ—Ä PostgreSQL
    // _ "github.com/mattn/go-sqlite3" // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ SQLite
    
    "visualmath-platform/internal/handlers"
)

func main() {
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
    fmt.Println("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º VisualMath —Å–µ—Ä–≤–µ—Ä...")
    
    err := godotenv.Load()
    if err != nil {
        log.Println("‚ö†Ô∏è  .env file not found, using default values")
    }
    
    // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    db, err := initDatabase()
    if err != nil {
        log.Fatal("‚ùå Database error:", err)
    }
    defer db.Close()
    
    fmt.Println("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!")
    
    // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    authHandler := &handlers.AuthHandler{DB: db}
    oauthHandler := handlers.NewOAuthHandler(db)
    
    // 4. –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä chi (–≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ http.HandleFunc)
    r := chi.NewRouter()
    
    // 5. –î–æ–±–∞–≤–ª—è–µ–º middleware (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û)
    r.Use(middleware.Logger)      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
    r.Use(middleware.Recoverer)   // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞–Ω–∏–∫–∏
    r.Use(middleware.RequestID)   // ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    
    // 6. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
    // –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫: web/static/css/, web/static/js/
    r.Handle("/static/*", http.StripPrefix("/static/", 
        http.FileServer(http.Dir("web/static"))))
    
    // 7. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç—ã
    
    // 7.1 –ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
    r.Get("/", homeHandler)
    r.Get("/login", loginPageHandler)
    r.Get("/register", registerPageHandler)
    r.Get("/dashboard", dashboardPageHandler)
    r.Get("/test", testHandler)
    
    // 7.2 API –º–∞—Ä—à—Ä—É—Ç—ã (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–≤—Ö–æ–¥)
    r.Post("/api/register", authHandler.Register)
    r.Post("/api/login", authHandler.Login)
    
    // 7.3 OAuth –º–∞—Ä—à—Ä—É—Ç—ã (VK –∏ Google)
    r.Get("/auth/vk", oauthHandler.VKAuthHandler)
    r.Get("/auth/vk/callback", oauthHandler.VKCallbackHandler)
    r.Get("/auth/google", oauthHandler.GoogleAuthHandler)
    r.Get("/auth/google/callback", oauthHandler.GoogleCallbackHandler)
    r.Get("/oauth/success", oauthHandler.OAuthSuccessHandler)
    
    // 7.4 –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏)
    r.Route("/api", func(r chi.Router) {
        // –ó–¥–µ—Å—å –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT
        r.Get("/user/profile", func(w http.ResponseWriter, r *http.Request) {
            w.Header().Set("Content-Type", "application/json")
            fmt.Fprintf(w, `{"message": "Profile endpoint - to be implemented"}`)
        })
    })
    
    // 8. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    port := os.Getenv("PORT")
    if port == "" {
        port = "8080"
    }
    
    fmt.Printf("‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω!\n")
    fmt.Printf("üåê –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: http://localhost:%s\n", port)
    fmt.Printf("üîó –í—Ö–æ–¥ —á–µ—Ä–µ–∑ VK: http://localhost:%s/auth/vk\n", port)
    fmt.Printf("üîó –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google: http://localhost:%s/auth/google\n", port)
    fmt.Printf("üìÇ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã: http://localhost:%s/static/css/style.css\n", port)
    fmt.Println("üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    
    log.Fatal(http.ListenAndServe(":"+port, r))
}

// initDatabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
func initDatabase() (*sql.DB, error) {
    // –í–∞—Ä–∏–∞–Ω—Ç 1: PostgreSQL (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    connStr := fmt.Sprintf("postgres://%s:%s@%s/%s?sslmode=disable",
        os.Getenv("DB_USER"),
        os.Getenv("DB_PASSWORD"),
        os.Getenv("DB_HOST"),
        os.Getenv("DB_NAME"))
    
    // –í–∞—Ä–∏–∞–Ω—Ç 2: SQLite (–ø—Ä–æ—â–µ –¥–ª—è –Ω–∞—á–∞–ª–∞)
    // connStr := "visualmath.db"
    // return sql.Open("sqlite3", connStr)
    
    db, err := sql.Open("postgres", connStr)
    if err != nil {
        return nil, fmt.Errorf("database connection error: %v", err)
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    err = db.Ping()
    if err != nil {
        return nil, fmt.Errorf("cannot connect to database: %v", err)
    }
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    err = createTables(db)
    if err != nil {
        log.Printf("‚ö†Ô∏è  Warning creating tables: %v", err)
    }
    
    return db, nil
}

// createTables —Å–æ–∑–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
func createTables(db *sql.DB) error {
    queries := []string{
        // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        `CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            login VARCHAR(255) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            full_name VARCHAR(255) NOT NULL,
            user_type VARCHAR(50) NOT NULL CHECK (user_type IN ('student', 'teacher', 'admin')),
            group_number VARCHAR(100),
            email VARCHAR(255) UNIQUE NOT NULL,
            email_verified BOOLEAN DEFAULT FALSE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )`,
        
        // –¢–∞–±–ª–∏—Ü–∞ –∫—É—Ä—Å–æ–≤
        `CREATE TABLE IF NOT EXISTS courses (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) UNIQUE NOT NULL
        )`,
        
        // –¢–∞–±–ª–∏—Ü–∞ OAuth —Å–≤—è–∑–µ–π
        `CREATE TABLE IF NOT EXISTS oauth_connections (
            id SERIAL PRIMARY KEY,
            user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
            provider VARCHAR(20) NOT NULL,
            provider_user_id VARCHAR(100) NOT NULL,
            email VARCHAR(255),
            full_name VARCHAR(255),
            avatar_url TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(provider, provider_user_id)
        )`,
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫—É—Ä—Å—ã
        `INSERT INTO courses (name) VALUES 
            ('–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑'),
            ('–õ–∏–Ω–µ–π–Ω–∞—è –∞–ª–≥–µ–±—Ä–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è'),
            ('–î–∏—Å–∫—Ä–µ—Ç–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'),
            ('–≠–∫–æ–Ω–æ–º–∏–∫–∞')
        ON CONFLICT (name) DO NOTHING`,
    }
    
    for _, query := range queries {
        _, err := db.Exec(query)
        if err != nil {
            return fmt.Errorf("error executing query %s: %v", query[:50], err)
        }
    }
    
    fmt.Println("‚úÖ –¢–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
    return nil
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
func homeHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    
    html := `
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VisualMath - –ì–ª–∞–≤–Ω–∞—è</title>
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <div style="text-align: center; padding: 50px;">
            <h1>üéì VisualMath Platform</h1>
            <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏</p>
            
            <div style="margin: 30px 0;">
                <a href="/login" style="padding: 12px 30px; background: #3498db; 
                   color: white; text-decoration: none; border-radius: 5px; margin: 10px;">
                   üîë –í–æ–π—Ç–∏
                </a>
                <a href="/register" style="padding: 12px 30px; background: #2ecc71; 
                   color: white; text-decoration: none; border-radius: 5px; margin: 10px;">
                   üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </a>
            </div>
            
            <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑:</h3>
                <div style="margin: 15px;">
                    <a href="/auth/vk" style="margin: 0 10px; color: #4a76a8;">VK</a>
                    <a href="/auth/google" style="margin: 0 10px; color: #db4437;">Google</a>
                </div>
                <p><a href="/test">–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a></p>
                <p><a href="/static/css/style.css">CSS —Ñ–∞–π–ª</a></p>
            </div>
        </div>
    </body>
    </html>
    `
    
    fmt.Fprintf(w, html)
}

func loginPageHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    
    html := `
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ - VisualMath</title>
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <div style="max-width: 400px; margin: 100px auto; padding: 30px; 
             background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; color: #2c3e50;">üîê –í—Ö–æ–¥</h1>
            
            <div style="text-align: center; margin: 20px 0;">
                <a href="/auth/vk" style="display: inline-block; padding: 10px 20px; margin: 5px; 
                   background: #4a76a8; color: white; text-decoration: none; border-radius: 5px;">
                   VK
                </a>
                <a href="/auth/google" style="display: inline-block; padding: 10px 20px; margin: 5px; 
                   background: #db4437; color: white; text-decoration: none; border-radius: 5px;">
                   Google
                </a>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <hr style="border: none; border-top: 1px solid #eee;">
                <span style="background: white; padding: 0 10px;">–∏–ª–∏</span>
            </div>
            
            <form id="loginForm" style="margin-top: 20px;">
                <input type="text" id="login" name="login" placeholder="–õ–æ–≥–∏–Ω" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="password" id="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                
                <button type="submit" 
                        style="width: 100%; padding: 12px; background: #3498db; color: white; 
                               border: none; border-radius: 5px; margin-top: 20px; cursor: pointer;">
                    –í–æ–π—Ç–∏
                </button>
            </form>
            
            <div id="message" style="margin: 15px 0; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p><a href="/register">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
                <p><a href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
            </div>
        </div>

        <script>
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    login: document.getElementById('login').value,
                    password: document.getElementById('password').value
                };
                
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    const messageDiv = document.getElementById('message');
                    
                    if (response.ok) {
                        messageDiv.style.background = '#d4edda';
                        messageDiv.style.color = '#155724';
                        messageDiv.textContent = '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
                        messageDiv.style.display = 'block';
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                        localStorage.setItem('token', result.token);
                        localStorage.setItem('user', JSON.stringify(result.user));
                        
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1000);
                    } else {
                        messageDiv.style.background = '#f8d7da';
                        messageDiv.style.color = '#721c24';
                        messageDiv.textContent = '‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    const messageDiv = document.getElementById('message');
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                    messageDiv.style.display = 'block';
                }
            });
        </script>
    </body>
    </html>
    `
    
    fmt.Fprintf(w, html)
}

func registerPageHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    
    html := `
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - VisualMath</title>
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <div style="max-width: 400px; margin: 50px auto; padding: 30px; 
             background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; color: #2c3e50;">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            
            <form id="registerForm" style="margin-top: 20px;">
                <input type="text" id="login" name="login" placeholder="–õ–æ–≥–∏–Ω" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="password" id="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="text" id="full_name" name="full_name" placeholder="–§–ò–û" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="email" id="email" name="email" placeholder="Email" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                
                <select id="user_type" name="user_type" style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                    <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
                    <option value="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</option>
                </select>
                
                <input type="text" id="group_number" name="group_number" placeholder="–ù–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã (–¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)" 
                       style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; display: none;">
                
                <button type="submit" 
                        style="width: 100%; padding: 12px; background: #2ecc71; color: white; 
                               border: none; border-radius: 5px; margin-top: 20px; cursor: pointer;">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </form>
            
            <div id="message" style="margin: 15px 0; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p><a href="/login">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a></p>
                <p><a href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
            </div>
        </div>

        <script>
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≥—Ä—É–ø–ø—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            document.getElementById('user_type').addEventListener('change', function() {
                const groupField = document.getElementById('group_number');
                if (this.value === 'student') {
                    groupField.style.display = 'block';
                    groupField.required = true;
                } else {
                    groupField.style.display = 'none';
                    groupField.required = false;
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    login: document.getElementById('login').value,
                    password: document.getElementById('password').value,
                    full_name: document.getElementById('full_name').value,
                    email: document.getElementById('email').value,
                    user_type: document.getElementById('user_type').value,
                    group_number: document.getElementById('group_number').value
                };
                
                try {
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    const messageDiv = document.getElementById('message');
                    
                    if (response.ok) {
                        messageDiv.style.background = '#d4edda';
                        messageDiv.style.color = '#155724';
                        messageDiv.textContent = '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
                        messageDiv.style.display = 'block';
                        
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    } else {
                        messageDiv.style.background = '#f8d7da';
                        messageDiv.style.color = '#721c24';
                        messageDiv.textContent = '‚ùå ' + (result.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    const messageDiv = document.getElementById('message');
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                    messageDiv.style.display = 'block';
                }
            });
        </script>
    </body>
    </html>
    `
    
    fmt.Fprintf(w, html)
}

func dashboardPageHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    
    html := `
    <!DOCTYPE html>
    <html>
    <head>
        <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - VisualMath</title>
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <div style="text-align: center; padding: 50px;">
            <h1>üìä –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
            <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
            <p><a href="/login">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
            <p><a href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
        </div>
    </body>
    </html>
    `
    
    fmt.Fprintf(w, html)
}

func testHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    
    html := `
    <!DOCTYPE html>
    <html>
    <head><title>–¢–µ—Å—Ç</title></head>
    <body style="padding: 50px; text-align: center;">
        <h1 style="color: green;">‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!</h1>
        <p>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ</p>
        <p>OAuth –º–∞—Ä—à—Ä—É—Ç—ã:</p>
        <ul style="list-style: none; padding: 0;">
            <li><a href="/auth/vk">/auth/vk</a> - –í—Ö–æ–¥ —á–µ—Ä–µ–∑ VK</li>
            <li><a href="/auth/google">/auth/google</a> - –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google</li>
        </ul>
        <p><a href="/">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
    </body>
    </html>
    `
    
    fmt.Fprintf(w, html)
}